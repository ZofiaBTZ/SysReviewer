import os
import glob
import sys
import subprocess
import re
import collections
#import xlsxwriter
import sys
from pdfminer.pdfparser import PDFParser
from pdfminer.pdfdocument import PDFDocument, PDFNoOutlines
from pdfminer.pdfinterp import PDFResourceManager, PDFPageInterpreter
from pdfminer.converter import PDFPageAggregator
from pdfminer.layout import LAParams, LTTextBox, LTTextLine, LTFigure, LTImage
from pdfminer.converter import TextConverter
from pdfminer.pdfpage import PDFPage
from cStringIO import StringIO

reload(sys)
sys.setdefaultencoding('utf8')


def convert_pdf_to_txt(path):
    rsrcmgr = PDFResourceManager()
    retstr = StringIO()
    codec = 'utf-8'
    laparams = LAParams()
    device = TextConverter(rsrcmgr, retstr, codec=codec, laparams=laparams)
    fp = file(path, 'rb')
    interpreter = PDFPageInterpreter(rsrcmgr, device)
    password = ""
    maxpages = 0
    caching = True
    pagenos=set()
    for page in PDFPage.get_pages(fp, pagenos, maxpages=maxpages, password=password,caching=caching, check_extractable=True):
        interpreter.process_page(page)
    fp.close()
    device.close()
    str = retstr.getvalue()
    retstr.close()
    return str

#add proper parsing of arguments
# if ocr needed -- https://pythontips.com/2016/02/25/ocr-on-pdf-files-using-python/

def remove_non_ascii(text):
    text = re.sub(r'[\357\254\200]+', 'ff', text)
    text = re.sub(r'[\357\254\201]+', 'fi', text)
    text = re.sub(r'[\357\254\202]+', 'fl', text)
    text = re.sub('fffi ', 'fi', text)
    text = re.sub('ff ', 'ff', text)
    text = re.sub('[^0-9a-zA-Z]+', ' ', text)
 #   text = re.sub(r'[^\x00-\x7F]+',' ', text) 
    return(text)

def get_toc(pdf_path):    #pdf structure of the file
    infile = open(pdf_path, 'rb')
    parser = PDFParser(infile)
    document = PDFDocument(parser)

    
    toc = list()
    try:
        for (level,title,dest,a,structelem) in document.get_outlines():
            print remove_non_ascii(title.strip()) 
            toc = '-'
    except PDFNoOutlines:
        pass
    return toc

# TODO: change input, not order dependent
#   parser = argparse.ArgumentParser(description='Description of your program')
#parser.add_argument('-f','--foo', help='Description for foo argument', required=True)
#parser.add_argument('-b','--bar', help='Description for bar argument', required=True)
#args = vars(parser.parse_args()) 

districts_file_name = sys.argv[1]
stats = [[0 for i in range(50)] for j in range (50)]  # change to length
articles_dir = sys.argv[2]
districts_file = open(districts_file_name)
districts = districts_file.read()
districts = districts.split()
for district in districts:
    print district
    
#workbook = xlsxwriter.Workbook('zosienka.xlsx')
#worksheet1 = workbook.add_worksheet()  # writing directly into the excel file very slow. Have as data matrix, then write into excel.

col = 1
row = 0
#for district in districts:
#        worksheet1.write(row, col, district)
#        col = col + 1
dir_files = sys.argv[2]
summary_file = sys.argv[3]
last_file = '0'
#if len(sys.argv)>3:
#    last_file = sys.argv[3]
txt_dir = sys.argv[4]
summary = open(summary_file, "w")
os.chdir(dir_files)
for f in glob.glob("*.pdf"):
    print(f)
    # if f > last_file:    
    try:
        retvalue = convert_pdf_to_txt(f)
        retvalue = remove_non_ascii(retvalue)
        new_name = f.replace(".pdf", ".txt")
        new_name = txt_dir + new_name
        print(new_name)
        print(os.getcwd())
        with open(new_name, "w+") as ff:
            ff.write(retvalue)
    except:
        print(f + "   not parsed")
        continue            
        #file.close()
        #adxd different words list
    summary.write(f)
    #        col = 0
    #        row = row + 1
    #        worksheet1.write(row, col, f)
    toc = get_toc(f)
    if toc == list():
        toc = retvalue.split('.')[0]
        #print(toc)
    else:
        toc = ' '.join(get_toc(f))
        #print(toc)
    summary.write(toc)
    summary.write(" \n")
summary.close()
 #       retvalue_l = retvalue.lower()        
 #       wordlist = retvalue_l.split()
 #       wordfreq = []
 #       for district in districts:
 #                freq = wordlist.count(district)
 #                wordfreq.append(freq)
        #         col = col + 1
        #               worksheet1.write(row, col, freq)
 #       print(str(zip(districts, wordfreq)))  #add to stats and transpose
 #       #add wordfreq to excel, districts, wordfreq (or before, in for)
 #       print(" ")
 #       print(collections.Counter(retvalue.split()))
 #       print(" ")
 #       print(" ")

#workbook.close()
    # at the end:
    #district 1: 17 papers, dates: 2001-2012
    #...

    #district 1: papier 1, 12, dates 2001, 2005, 2007, NGO1, NGO2, intervention1, intervention2
    
# check the title --- more points for word in the title. Don't look for words in Bibliography
